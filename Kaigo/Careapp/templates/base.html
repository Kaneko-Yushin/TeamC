{% set is_admin = (session.get('staff_role') == 'admin') %}
{% set is_staff = (session.get('staff_name') is not none) %}
{% set is_family = (session.get('family_name') is not none) %}
<!doctype html>
<html lang="{{ get_locale() or 'ja' }}">
  <head>
    <meta charset="utf-8">
    <title>{{ _("ãƒ‡ã‚¸ã‚¿ãƒ«ä»‹è­·æ—¥èªŒ") }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      body.main-wrap{ background:#f5faf7; min-height:100vh; font-family:"Segoe UI", system-ui, sans-serif; }
      .app-bar{ background:#256b3f; color:#fff; }
      .app-bar a{ color:#fff; text-decoration:none; }
      .brand{ font-weight:800; letter-spacing:.02em; }
      .pill{ background:#1e5833; border:none; border-radius:9999px; padding:.35rem .75rem; color:#fff; }
      .content-wrap{ max-width:1200px; margin:0 auto; padding:20px; }

      /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼å…±é€šã®ã‚«ãƒ¼ãƒ‰æ„Ÿï¼ˆhomeã‚„ç®¡ç†ãªã©ã§ä½¿ã†ï¼‰ */
      .menu-card{
        background:#fff; border:none; border-radius:18px;
        box-shadow:0 12px 32px rgba(0,0,0,.08);
        transition: transform .15s ease, box-shadow .15s ease; height:100%;
      }
      .menu-card:hover{ transform:translateY(-2px); box-shadow:0 16px 40px rgba(0,0,0,.1); }
      a.menu-link{text-decoration:none;color:inherit}

      /* ãƒ†ãƒ¼ãƒ–ãƒ«è¦‹ã‚„ã™ã•å¾®èª¿æ•´ */
      table.table th, table.table td{ vertical-align: middle; }

      /* ãƒ•ãƒƒã‚¿ãƒ¼ */
      footer{ color:#6b7d74; font-size:.9rem; }
    </style>
  </head>
  <body class="main-wrap">

    <!-- Top Nav -->
    <nav class="navbar navbar-expand-lg app-bar">
      <div class="container-fluid">
        <a class="navbar-brand brand" href="{{ url_for('home') }}">ğŸ©º {{ _("ãƒ‡ã‚¸ã‚¿ãƒ«ä»‹è­·æ—¥èªŒ") }}</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topnav" aria-controls="topnav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
        </button>

        <div class="collapse navbar-collapse" id="topnav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            {% if is_staff %}
              <li class="nav-item"><a class="nav-link" href="{{ url_for('records') }}">{{ _("è¨˜éŒ²ä¸€è¦§") }}</a></li>
              <li class="nav-item"><a class="nav-link" href="{{ url_for('add_record') }}">{{ _("è¨˜éŒ²å…¥åŠ›") }}</a></li>
              <li class="nav-item"><a class="nav-link" href="{{ url_for('handover') }}">{{ _("å¼•ç¶™ã") }}</a></li>
              {% if is_admin %}
                <li class="nav-item"><a class="nav-link" href="{{ url_for('users_page') }}">{{ _("åˆ©ç”¨è€…ä¸€è¦§") }}</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('add_user') }}">{{ _("åˆ©ç”¨è€…ç™»éŒ²") }}</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_page') }}">{{ _("è¨­å®š") }}</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('camera_page') }}">{{ _("è¦‹å®ˆã‚Šã‚«ãƒ¡ãƒ©") }}</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('album_index') }}">{{ _("ã‚¢ãƒ«ãƒãƒ ") }}</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_family') }}">{{ _("å®¶æ—ç®¡ç†") }}</a></li>
              {% endif %}
            {% endif %}

            {% if is_family and not is_staff %}
              <li class="nav-item"><a class="nav-link" href="{{ url_for('family_home') }}">{{ _("å®¶æ—ãƒˆãƒƒãƒ—") }}</a></li>
            {% endif %}
          </ul>

          <!-- å³å´ï¼šè¨€èªã‚¹ã‚¤ãƒƒãƒ / ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ -->
          <div class="d-flex align-items-center gap-2">
            <!-- Language switch -->
            <div class="dropdown">
              <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                ğŸŒ {{ _("è¨€èª") }}
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="return setLang('ja')">æ—¥æœ¬èª</a></li>
                <li><a class="dropdown-item" href="#" onclick="return setLang('en')">English</a></li>
              </ul>
            </div>

            {% if is_staff %}
              <span class="pill">{{ session.get('staff_name') }}{% if is_admin %} / Admin{% endif %}</span>
              <a class="btn btn-outline-light btn-sm" href="{{ url_for('logout') }}">{{ _("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ") }}</a>
            {% elif is_family %}
              <span class="pill">{{ session.get('family_name') }} / Family</span>
              <a class="btn btn-outline-light btn-sm" href="{{ url_for('family_logout') }}">{{ _("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ") }}</a>
            {% else %}
              <a class="btn btn-outline-light btn-sm" href="{{ url_for('staff_login') }}">{{ _("ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³") }}</a>
              <a class="btn btn-outline-light btn-sm" href="{{ url_for('family_login') }}">{{ _("å®¶æ—ãƒ­ã‚°ã‚¤ãƒ³") }}</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <!-- Flash messages -->
    <div class="container mt-3" style="max-width:1000px;">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert alert-success shadow-sm" role="alert">
            {% for m in messages %}
              <div>{{ m }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>

    <!-- Main content -->
    <main class="content-wrap">
      {% block content %}{% endblock %}
    </main>

    <footer class="content-wrap pb-5">
      <hr>
      <div class="d-flex flex-wrap justify-content-between align-items-center">
        <div>Â© {{ now().year if now else "" }} CareApp</div>
        <div class="text-muted">
          <a href="{{ url_for('healthz') }}" class="text-muted" style="text-decoration:none;">healthz</a>
        </div>
      </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- è¨€èªåˆ‡æ›¿ï¼šã‚µãƒ¼ãƒå´ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ â†’ googtransã‚¯ãƒƒã‚­ãƒ¼é™¤å» â†’ ãƒãƒ¼ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰ -->
    <script>
      function clearGoogleTranslateCookies() {
        const names = ['googtrans'];
        const domains = [location.hostname, '.' + location.hostname.replace(/^www\./,'')];
        names.forEach((name) => {
          document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
          domains.forEach(d => {
            document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=' + d;
          });
        });
      }
      function setLang(lang){
        const next = location.pathname + location.search + location.hash;
        fetch('/set_language/' + encodeURIComponent(lang) + '?next=' + encodeURIComponent(next), {credentials:'same-origin'})
          .then(() => { clearGoogleTranslateCookies(); location.reload(true); });
        return false;
      }
    </script>

    <!-- PWA: Service Workerï¼ˆstatic/sw.js ãŒã‚ã‚Œã°ç™»éŒ²ã•ã‚Œã¾ã™ï¼‰ -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          const swUrl = '{{ url_for("static", filename="sw.js") }}';
          fetch(swUrl, {method:'HEAD'}).then(res => {
            if (res.ok) navigator.serviceWorker.register(swUrl);
          }).catch(()=>{});
        });
      }
    </script>
  </body>
</html>
